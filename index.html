<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relly - Household Budget</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif;
            background: #F3F4F6;
            color: #111827;
        }
        .gradient-green { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBQ2HrvtpMEW6ZvxjE--LWk2crbOfdNlHM",
            authDomain: "household-budget-app-4aba1.firebaseapp.com",
            projectId: "household-budget-app-4aba1",
            storageBucket: "household-budget-app-4aba1.firebasestorage.app",
            messagingSenderId: "40062087444",
            appId: "1:40062087444:web:4a6621cd127b39cf86d201"
        };
        
        let db, auth, googleProvider;
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        googleProvider = new firebase.auth.GoogleAuthProvider();

        const formatMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0);

        // Add Transaction Modal
        const AddTransaction = ({ isOpen, onClose, accounts, categories, vehicles }) => {
            const [type, setType] = useState('expense');
            const [amount, setAmount] = useState('');
            const [desc, setDesc] = useState('');
            const [category, setCategory] = useState('');
            const [account, setAccount] = useState('');
            const [vehicle, setVehicle] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            const save = async () => {
                if (!amount || !desc || !category || !account) return alert('Fill all required fields');
                
                const finalAmount = type === 'expense' ? -Math.abs(parseFloat(amount)) : Math.abs(parseFloat(amount));
                
                await db.collection('transactions').add({
                    amount: finalAmount,
                    description: desc,
                    category,
                    accountId: account,
                    vehicleId: vehicle || null,
                    date,
                    createdAt: new Date()
                });
                
                setAmount('');
                setDesc('');
                setCategory('');
                setVehicle('');
                onClose();
            };

            if (!isOpen) return null;

            const cats = Object.keys(categories).filter(c => categories[c] === type);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4">Add Transaction</h2>
                        
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setType('expense')} className={`flex-1 py-2 rounded-lg font-bold ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-100'}`}>Expense</button>
                            <button onClick={() => setType('income')} className={`flex-1 py-2 rounded-lg font-bold ${type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-100'}`}>Income</button>
                        </div>

                        <input type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} placeholder="Amount" className="w-full p-3 border rounded-lg mb-3 text-xl font-bold" />
                        <input type="text" value={desc} onChange={e => setDesc(e.target.value)} placeholder="Description" className="w-full p-3 border rounded-lg mb-3" />
                        
                        <select value={category} onChange={e => setCategory(e.target.value)} className="w-full p-3 border rounded-lg mb-3">
                            <option value="">Select Category</option>
                            {cats.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>

                        <select value={account} onChange={e => setAccount(e.target.value)} className="w-full p-3 border rounded-lg mb-3">
                            <option value="">Select Account</option>
                            {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                        </select>

                        <select value={vehicle} onChange={e => setVehicle(e.target.value)} className="w-full p-3 border rounded-lg mb-3">
                            <option value="">No Vehicle</option>
                            {vehicles.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                        </select>

                        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 border rounded-lg mb-4" />

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 bg-gray-100 rounded-lg font-bold">Cancel</button>
                            <button onClick={save} className="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold">Save</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App
        const App = ({ user, logout }) => {
            const [tab, setTab] = useState('dashboard');
            const [showAdd, setShowAdd] = useState(false);
            
            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [categories, setCategories] = useState({});
            const [vehicles, setVehicles] = useState([]);
            const [budgets, setBudgets] = useState({});

            // Load data
            useEffect(() => {
                const unsub1 = db.collection('transactions').onSnapshot(s => setTransactions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub2 = db.collection('accounts').onSnapshot(s => setAccounts(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub3 = db.collection('categories').onSnapshot(s => {
                    const cats = {};
                    s.docs.forEach(d => cats[d.id] = d.data().type);
                    setCategories(cats);
                });
                const unsub4 = db.collection('vehicles').onSnapshot(s => setVehicles(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub5 = db.collection('budgets').doc('monthly').onSnapshot(d => setBudgets(d.exists ? d.data() : {}));
                
                return () => { unsub1(); unsub2(); unsub3(); unsub4(); unsub5(); };
            }, []);

            // Calculate total cash (sum of all account balances)
            const totalCash = useMemo(() => {
                return accounts.reduce((sum, acc) => {
                    const accTx = transactions.filter(t => t.accountId === acc.id);
                    const balance = (acc.startingBalance || 0) + accTx.reduce((s, t) => s + t.amount, 0);
                    return sum + balance;
                }, 0);
            }, [accounts, transactions]);

            // This month stats
            const thisMonth = useMemo(() => {
                const now = new Date();
                const txs = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const income = txs.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
                const spending = txs.filter(t => t.amount < 0).reduce((s, t) => s + Math.abs(t.amount), 0);
                return { income, spending };
            }, [transactions]);

            // Spending comparisons
            const comparisons = useMemo(() => {
                const now = new Date();
                const days30 = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                const days60 = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);
                const days90 = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                
                const get = (cutoff) => transactions.filter(t => new Date(t.date) >= cutoff && t.amount < 0).reduce((s, t) => s + Math.abs(t.amount), 0);
                
                return { days30: get(days30), days60: get(days60), days90: get(days90) };
            }, [transactions]);

            // YTD by category
            const ytd = useMemo(() => {
                const now = new Date();
                const txs = transactions.filter(t => new Date(t.date).getFullYear() === now.getFullYear());
                
                const income = {};
                const expenses = {};
                
                txs.forEach(t => {
                    const cat = t.category || 'Uncategorized';
                    const amt = Math.abs(t.amount);
                    if (t.amount > 0) income[cat] = (income[cat] || 0) + amt;
                    else expenses[cat] = (expenses[cat] || 0) + amt;
                });
                
                return { income, expenses };
            }, [transactions]);

            // Budget status (this month)
            const budgetStatus = useMemo(() => {
                const now = new Date();
                const thisMonthTx = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && t.amount < 0;
                });
                
                const spent = {};
                thisMonthTx.forEach(t => {
                    const cat = t.category || 'Uncategorized';
                    spent[cat] = (spent[cat] || 0) + Math.abs(t.amount);
                });
                
                return Object.keys(budgets).map(cat => {
                    const budget = budgets[cat];
                    const amount = spent[cat] || 0;
                    const pct = budget > 0 ? (amount / budget) * 100 : 0;
                    return { cat, budget, spent: amount, pct, over: amount > budget };
                });
            }, [transactions, budgets]);

            // Recent transactions
            const recent = useMemo(() => 
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10),
                [transactions]
            );

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="gradient-green text-white p-4 sticky top-0 z-10 shadow-lg">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-black">Relly</h1>
                                <p className="text-xs opacity-90">Household Budget</p>
                            </div>
                            <button onClick={logout} className="text-sm font-semibold">Sign Out</button>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto p-4 pb-24">
                        {tab === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                {/* TOTAL CASH - BIG */}
                                <div className="bg-white rounded-2xl shadow-lg p-8 border-4 border-green-100">
                                    <div className="text-sm font-bold text-gray-600 uppercase mb-2">Total Cash</div>
                                    <div className="text-6xl font-black text-green-600">{formatMoney(totalCash)}</div>
                                </div>

                                {/* This Month */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h2 className="text-lg font-bold mb-4">This Month</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase mb-1">Income</div>
                                            <div className="text-2xl font-bold text-green-600">{formatMoney(thisMonth.income)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase mb-1">Spending</div>
                                            <div className="text-2xl font-bold text-red-600">{formatMoney(thisMonth.spending)}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Spending Comparisons */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h2 className="text-lg font-bold mb-4">Spending Trends</h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase mb-1">Last 30 Days</div>
                                            <div className="text-xl font-bold">{formatMoney(comparisons.days30)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase mb-1">Last 60 Days</div>
                                            <div className="text-xl font-bold">{formatMoney(comparisons.days60)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase mb-1">Last 90 Days</div>
                                            <div className="text-xl font-bold">{formatMoney(comparisons.days90)}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* YTD by Category */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h2 className="text-lg font-bold mb-4">Year-to-Date by Category</h2>
                                    
                                    <h3 className="text-sm font-bold text-green-600 mb-2">Income</h3>
                                    {Object.entries(ytd.income).sort((a,b) => b[1] - a[1]).map(([cat, amt]) => (
                                        <div key={cat} className="flex justify-between py-2 border-b">
                                            <span>{cat}</span>
                                            <span className="font-bold text-green-600">{formatMoney(amt)}</span>
                                        </div>
                                    ))}
                                    
                                    <h3 className="text-sm font-bold text-red-600 mb-2 mt-4">Expenses</h3>
                                    {Object.entries(ytd.expenses).sort((a,b) => b[1] - a[1]).map(([cat, amt]) => (
                                        <div key={cat} className="flex justify-between py-2 border-b">
                                            <span>{cat}</span>
                                            <span className="font-bold text-red-600">{formatMoney(amt)}</span>
                                        </div>
                                    ))}
                                </div>

                                {/* Budget Status */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h2 className="text-lg font-bold mb-4">Budget Status (This Month)</h2>
                                    {budgetStatus.map(b => (
                                        <div key={b.cat} className="mb-4">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-semibold">{b.over ? 'üî¥' : b.pct > 70 ? 'üü°' : 'üü¢'} {b.cat}</span>
                                                <span className="text-sm">
                                                    <span className="font-bold">{formatMoney(b.spent)}</span>
                                                    <span className="text-gray-500"> / {formatMoney(b.budget)}</span>
                                                </span>
                                            </div>
                                            <div className="bg-gray-200 rounded-full h-2">
                                                <div className={`h-full rounded-full ${b.over ? 'bg-red-500' : b.pct > 70 ? 'bg-yellow-500' : 'bg-green-500'}`} style={{width: `${Math.min(b.pct, 100)}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {budgetStatus.length === 0 && <p className="text-gray-500">No budgets set. Go to Settings.</p>}
                                </div>

                                {/* Recent */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h2 className="text-lg font-bold mb-4">Recent Transactions</h2>
                                    {recent.map(t => (
                                        <div key={t.id} className="flex justify-between py-3 border-b">
                                            <div>
                                                <div className="font-semibold">{t.description}</div>
                                                <div className="text-xs text-gray-500">{t.date} ‚Ä¢ {t.category}</div>
                                            </div>
                                            <div className={`font-bold ${t.amount > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {t.amount > 0 ? '+' : ''}{formatMoney(t.amount)}
                                            </div>
                                        </div>
                                    ))}
                                    {recent.length === 0 && <p className="text-gray-500">No transactions yet.</p>}
                                </div>
                            </div>
                        )}

                        {tab === 'vehicles' && (
                            <div className="fade-in">
                                <h2 className="text-xl font-bold mb-4">Vehicle Expenses</h2>
                                {vehicles.map(v => {
                                    const vTx = transactions.filter(t => t.vehicleId === v.id);
                                    const total = vTx.reduce((s, t) => s + Math.abs(t.amount), 0);
                                    return (
                                        <div key={v.id} className="bg-white rounded-xl shadow p-6 mb-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <h3 className="text-lg font-bold">{v.name}</h3>
                                                <button onClick={async () => {
                                                    if (confirm(`Delete ${v.name}?`)) await db.collection('vehicles').doc(v.id).delete();
                                                }} className="text-red-600 text-sm font-semibold">Delete</button>
                                            </div>
                                            <div className="text-3xl font-black text-gray-900">{formatMoney(total)}</div>
                                            <div className="text-sm text-gray-500">{vTx.length} transactions</div>
                                        </div>
                                    );
                                })}
                                
                                <div className="bg-white rounded-xl shadow p-6 mt-6">
                                    <h3 className="font-bold mb-3">Add Vehicle</h3>
                                    <form onSubmit={async e => {
                                        e.preventDefault();
                                        const name = e.target.vname.value.trim();
                                        if (name) {
                                            await db.collection('vehicles').add({name});
                                            e.target.reset();
                                        }
                                    }} className="flex gap-3">
                                        <input name="vname" placeholder="Vehicle name" className="flex-1 p-3 border rounded-lg" />
                                        <button type="submit" className="px-6 py-3 bg-green-600 text-white rounded-lg font-bold">Add</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {tab === 'settings' && (
                            <div className="space-y-6 fade-in">
                                {/* Accounts */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h3 className="font-bold mb-4">Accounts</h3>
                                    {accounts.map(a => (
                                        <div key={a.id} className="flex justify-between p-3 bg-gray-50 rounded mb-2">
                                            <span className="font-semibold">{a.name}</span>
                                            <button onClick={async () => {
                                                if (confirm(`Delete ${a.name}?`)) await db.collection('accounts').doc(a.id).delete();
                                            }} className="text-red-600 text-sm">Delete</button>
                                        </div>
                                    ))}
                                    <form onSubmit={async e => {
                                        e.preventDefault();
                                        const name = e.target.aname.value.trim();
                                        const balance = parseFloat(e.target.abalance.value) || 0;
                                        if (name) {
                                            await db.collection('accounts').add({name, startingBalance: balance});
                                            e.target.reset();
                                        }
                                    }} className="mt-4 space-y-2">
                                        <input name="aname" placeholder="Account name" className="w-full p-3 border rounded-lg" />
                                        <input name="abalance" type="number" step="0.01" placeholder="Starting balance" className="w-full p-3 border rounded-lg" />
                                        <button type="submit" className="w-full py-3 bg-green-600 text-white rounded-lg font-bold">Add Account</button>
                                    </form>
                                </div>

                                {/* Categories */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h3 className="font-bold mb-4">Categories</h3>
                                    {Object.keys(categories).sort().map(c => (
                                        <div key={c} className="flex justify-between p-3 bg-gray-50 rounded mb-2">
                                            <span><strong>{c}</strong> <span className="text-xs text-gray-500">({categories[c]})</span></span>
                                            <button onClick={async () => {
                                                if (confirm(`Delete ${c}?`)) await db.collection('categories').doc(c).delete();
                                            }} className="text-red-600 text-sm">Delete</button>
                                        </div>
                                    ))}
                                    <form onSubmit={async e => {
                                        e.preventDefault();
                                        const name = e.target.cname.value.trim();
                                        const type = e.target.ctype.value;
                                        if (name) {
                                            await db.collection('categories').doc(name).set({type});
                                            e.target.reset();
                                        }
                                    }} className="mt-4 flex gap-2">
                                        <input name="cname" placeholder="Category name" className="flex-1 p-3 border rounded-lg" />
                                        <select name="ctype" className="p-3 border rounded-lg">
                                            <option value="expense">Expense</option>
                                            <option value="income">Income</option>
                                        </select>
                                        <button type="submit" className="px-6 py-3 bg-green-600 text-white rounded-lg font-bold">Add</button>
                                    </form>
                                </div>

                                {/* Budgets */}
                                <div className="bg-white rounded-xl shadow p-6">
                                    <h3 className="font-bold mb-4">Monthly Budgets</h3>
                                    <form onSubmit={async e => {
                                        e.preventDefault();
                                        const data = {};
                                        Object.keys(categories).filter(c => categories[c] === 'expense').forEach(cat => {
                                            const val = parseFloat(e.target[`budget_${cat}`]?.value) || 0;
                                            if (val > 0) data[cat] = val;
                                        });
                                        await db.collection('budgets').doc('monthly').set(data);
                                        alert('Budgets saved!');
                                    }}>
                                        {Object.keys(categories).filter(c => categories[c] === 'expense').sort().map(cat => (
                                            <div key={cat} className="mb-3">
                                                <label className="block text-sm font-semibold mb-1">{cat}</label>
                                                <input name={`budget_${cat}`} type="number" step="0.01" defaultValue={budgets[cat] || ''} placeholder="Budget amount" className="w-full p-3 border rounded-lg" />
                                            </div>
                                        ))}
                                        <button type="submit" className="w-full py-3 bg-green-600 text-white rounded-lg font-bold mt-4">Save Budgets</button>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* FAB */}
                    <button onClick={() => setShowAdd(true)} className="fixed bottom-20 right-6 w-16 h-16 gradient-green text-white rounded-full shadow-2xl text-3xl font-bold">+</button>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t h-16 flex z-20">
                        <button onClick={() => setTab('dashboard')} className="flex-1 flex flex-col items-center justify-center">
                            <span className="text-2xl">{tab === 'dashboard' ? 'üìä' : 'üìà'}</span>
                            <span className={`text-xs font-semibold ${tab === 'dashboard' ? 'text-green-600' : 'text-gray-500'}`}>Dashboard</span>
                        </button>
                        <button onClick={() => setTab('vehicles')} className="flex-1 flex flex-col items-center justify-center">
                            <span className="text-2xl">{tab === 'vehicles' ? 'üöó' : 'üöô'}</span>
                            <span className={`text-xs font-semibold ${tab === 'vehicles' ? 'text-green-600' : 'text-gray-500'}`}>Vehicles</span>
                        </button>
                        <button onClick={() => setTab('settings')} className="flex-1 flex flex-col items-center justify-center">
                            <span className="text-2xl">{tab === 'settings' ? '‚öôÔ∏è' : '‚öô'}</span>
                            <span className={`text-xs font-semibold ${tab === 'settings' ? 'text-green-600' : 'text-gray-500'}`}>Settings</span>
                        </button>
                    </nav>

                    <AddTransaction isOpen={showAdd} onClose={() => setShowAdd(false)} accounts={accounts} categories={categories} vehicles={vehicles} />
                </div>
            );
        };

        // Login
        const Login = () => {
            const login = async () => {
                try {
                    await auth.signInWithPopup(googleProvider);
                } catch (e) {
                    alert('Login failed');
                }
            };

            return (
                <div className="min-h-screen gradient-green flex flex-col items-center justify-center p-6">
                    <div className="w-24 h-24 bg-white rounded-3xl flex items-center justify-center mb-8">
                        <span className="text-5xl font-black text-green-600">R</span>
                    </div>
                    <h1 className="text-5xl font-black text-white mb-3">Relly</h1>
                    <p className="text-white/90 mb-12">Household Budget Tracker</p>
                    <button onClick={login} className="bg-white text-gray-900 font-bold py-4 px-8 rounded-2xl shadow-2xl">
                        Sign in with Google
                    </button>
                </div>
            );
        };

        // Root
        const Root = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                return auth.onAuthStateChanged(u => {
                    setUser(u);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;
            return user ? <App user={user} logout={() => auth.signOut()} /> : <Login />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
