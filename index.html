<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Relly v10 | Financial OS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Manrope"', 'sans-serif'] },
          colors: {
            zinc: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b' },
            emerald: { 500: '#10b981', 600: '#059669' },
            rose: { 500: '#f43f5e', 600: '#e11d48' },
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #fafafa; color: #18181b; -webkit-tap-highlight-color: transparent; }
    /* Glassmorphism */
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    /* Mobile Optimization */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    input, select, textarea { font-size: 16px !important; border-radius: 12px; } /* Prevent iOS Zoom */
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    /* Button Press Effect */
    .btn-press { transition: transform 0.05s; }
    .btn-press:active { transform: scale(0.96); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const Icon = ({ name, size = 24, className = "", onClick }) => {
      // Complete Icon Set
      const icons = {
        home: `<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>`,
        creditCard: `<rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line>`,
        pieChart: `<path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path>`,
        car: `<path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle>`,
        plus: `<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>`,
        x: `<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>`,
        logOut: `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>`,
        trendingUp: `<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>`,
        trendingDown: `<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline>`,
        arrowRight: `<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>`,
        trash: `<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>`,
        settings: `<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>`,
        download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>`,
        alert: `<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>`
      };
      return React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24",
        fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
        className: className, onClick: onClick,
        dangerouslySetInnerHTML: { __html: icons[name] || '' }
      });
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, createContext, useContext } = React;

    // --- FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyBQ2HrvtpMEW6ZvxjE--LWk2crbOfdNlHM",
      authDomain: "household-budget-app-4aba1.firebaseapp.com",
      projectId: "household-budget-app-4aba1",
      storageBucket: "household-budget-app-4aba1.firebasestorage.app",
      messagingSenderId: "40062087444",
      appId: "1:40062087444:web:4a6621cd127b39cf86d201"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // --- UTILS ---
    const Format = {
      money: (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0),
      date: (d) => new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' }).format(new Date(d)),
    };

    // --- TOAST SYSTEM (No Alerts) ---
    const ToastContext = createContext();
    const ToastProvider = ({ children }) => {
      const [toasts, setToasts] = useState([]);
      const addToast = (msg, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, msg, type }]);
        setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 2500);
      };
      return (
        <ToastContext.Provider value={addToast}>
          {children}
          <div className="fixed top-safe left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none p-4">
            {toasts.map(t => (
              <div key={t.id} className={`pointer-events-auto px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up ${t.type === 'error' ? 'bg-rose-600 text-white' : 'bg-zinc-900 text-white'}`}>
                <span className="font-bold text-sm">{t.msg}</span>
              </div>
            ))}
          </div>
        </ToastContext.Provider>
      );
    };

    // --- APP CONTEXT ---
    const AppContext = createContext();

    const AppProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState({ transactions: [], accounts: [], vehicles: [], rules: [] });
      const [modal, setModal] = useState(null);
      const toast = useContext(ToastContext);

      useEffect(() => auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); }), []);

      useEffect(() => {
        if (!user) return;
        // Optimization: Limit to 500 recent transactions for performance
        const unsubs = [
          db.collection('transactions').orderBy('date', 'desc').limit(500).onSnapshot(s => 
            setData(p => ({ ...p, transactions: s.docs.map(d => ({ id: d.id, ...d.data() })) }))
          ),
          db.collection('accounts').onSnapshot(s => 
            setData(p => ({ ...p, accounts: s.docs.map(d => ({ id: d.id, ...d.data() })) }))
          ),
          db.collection('vehicles').onSnapshot(s => 
            setData(p => ({ ...p, vehicles: s.docs.map(d => ({ id: d.id, ...d.data() })) }))
          ),
          db.collection('rules').onSnapshot(s => 
            setData(p => ({ ...p, rules: s.docs.map(d => ({ id: d.id, ...d.data() })) }))
          )
        ];
        setLoading(false);
        return () => unsubs.forEach(u => u());
      }, [user]);

      const actions = {
        login: () => auth.signInWithPopup(googleProvider),
        logout: () => auth.signOut(),
        openModal: (type, props) => setModal({ type, props }),
        closeModal: () => setModal(null),
        
        saveTransaction: async (tx) => {
           try {
             // 1. External Payment Logic
             if (tx.isExternalPayment) {
               // Only credit the Liability, do not debit an Asset
               await db.collection('transactions').add({
                  amount: Math.abs(tx.amount), 
                  category: 'External Payment', 
                  accountId: tx.toAccountId, 
                  date: tx.date,
                  createdAt: new Date()
               });
               toast('External Payment Recorded');
               return true;
             }

             // 2. Internal Transfer Logic (Checking -> Card)
             if (tx.category === 'Transfer' && tx.toAccountId) {
                const batch = db.batch();
                // Debit Checking
                const fromRef = db.collection('transactions').doc();
                batch.set(fromRef, { ...tx, amount: -Math.abs(tx.amount), category: 'Transfer Out', accountId: tx.accountId, createdAt: new Date() });
                // Credit Card
                const toRef = db.collection('transactions').doc();
                batch.set(toRef, { ...tx, amount: Math.abs(tx.amount), category: 'Transfer In', accountId: tx.toAccountId, createdAt: new Date() });
                await batch.commit();
                toast('Transfer Complete');
                return true;
             }
             
             // 3. Standard Transaction
             // Smart Rule Learning
             if (!tx.id && tx.description && tx.category && tx.category !== 'Uncategorized') {
                const existing = data.rules.find(r => r.merchant === tx.description);
                if (!existing) db.collection('rules').add({ merchant: tx.description, category: tx.category });
             }

             if (tx.id) {
               const { id, ...rest } = tx;
               await db.collection('transactions').doc(id).update(rest);
               toast('Updated');
             } else {
               await db.collection('transactions').add({ ...tx, createdAt: new Date() });
               toast('Saved');
             }
             return true;
           } catch (e) { toast('Error saving', 'error'); return false; }
        },
        deleteTransaction: async (id) => { await db.collection('transactions').doc(id).delete(); toast('Deleted'); },
        saveAccount: async (acc) => { if (acc.id) await db.collection('accounts').doc(acc.id).update(acc); else await db.collection('accounts').add(acc); toast('Account Saved'); },
        deleteAccount: async (id) => { await db.collection('accounts').doc(id).delete(); toast('Account Archived'); },
        saveVehicle: async (veh) => { if (veh.id) await db.collection('vehicles').doc(veh.id).update(veh); else await db.collection('vehicles').add(veh); toast('Vehicle Saved'); },
        deleteRule: async (id) => { await db.collection('rules').doc(id).delete(); toast('Rule Deleted'); },
        
        // Export Tool
        exportData: () => {
           const headers = ["Date", "Description", "Amount", "Category", "Account"];
           const rows = data.transactions.map(t => [t.date, `"${t.description}"`, t.amount, t.category, data.accounts.find(a=>a.id===t.accountId)?.name].join(","));
           const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
           const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = "relly_export.csv"; document.body.appendChild(link); link.click();
           toast('Export Downloaded');
        }
      };

      return <AppContext.Provider value={{ user, loading, data, modal, actions }}>{children}</AppContext.Provider>;
    };

    // --- MODAL SYSTEM ---
    const AddModal = () => {
       const { modal, actions, data } = useContext(AppContext);
       if (!modal) return null;
       const { type, prefill } = modal;
       
       const [mode, setMode] = useState(prefill?.mode || 'expense'); // expense, transfer, income
       const [amount, setAmount] = useState(prefill?.amount ? Math.abs(prefill.amount) : '');
       const [desc, setDesc] = useState('');
       const [accId, setAccId] = useState(prefill?.accountId || '');
       const [cat, setCat] = useState('');
       const [vehId, setVehId] = useState('');
       const [odo, setOdo] = useState('');
       const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
       const [toAccId, setToAccId] = useState(''); 
       const [isExternal, setIsExternal] = useState(false); // For paying bill from external source

       // Logic Gate: Odometer
       const validateOdo = () => {
          if(!vehId || !odo) return true;
          const veh = data.vehicles.find(v => v.id === vehId);
          // Find max existing odo
          let maxOdo = veh.startOdo || 0;
          data.transactions.forEach(t => { if(t.vehicleId === vehId && t.odometer > maxOdo) maxOdo = t.odometer; });
          
          if(parseInt(odo) < maxOdo) {
             alert(`Error: Odometer cannot be lower than previous (${maxOdo})`); // Using native alert here as a hard stop, could rely on Toast too
             return false;
          }
          return true;
       };

       // Logic: Predictive Suggestion
       const suggestions = useMemo(() => {
          if (desc.length < 2) return [];
          const matches = data.transactions.filter(t => t.description && t.description.toLowerCase().includes(desc.toLowerCase()));
          const cats = {}; matches.forEach(m => cats[m.category] = (cats[m.category] || 0) + 1);
          return Object.keys(cats).sort((a,b) => cats[b] - cats[a]).slice(0, 3);
       }, [desc, data.transactions]);

       const handleSubmit = async (e) => {
          e.preventDefault();
          if (!amount) return;
          if (!validateOdo()) return;

          let finalCat = cat || 'Uncategorized';
          let finalAmt = parseFloat(amount);
          
          if (mode === 'expense') finalAmt = -Math.abs(finalAmt);
          if (mode === 'transfer') finalCat = 'Transfer';

          await actions.saveTransaction({
             date: date,
             amount: finalAmt,
             description: desc || (mode === 'transfer' ? 'Payment' : 'Expense'),
             accountId: accId,
             category: finalCat,
             vehicleId: (finalCat === 'Vehicle' || finalCat === 'Fuel') ? vehId : null,
             odometer: odo ? parseInt(odo) : null,
             toAccountId: mode === 'transfer' ? toAccId : null,
             isExternalPayment: isExternal && mode === 'transfer'
          });
          actions.closeModal();
       };

       return (
         <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div className="absolute inset-0 bg-zinc-900/60 backdrop-blur-sm pointer-events-auto transition-opacity" onClick={actions.closeModal} />
            <div className="relative bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl pointer-events-auto p-6 animate-slide-up pb-safe">
               
               {/* Mode Switcher */}
               <div className="flex bg-zinc-100 p-1 rounded-xl mb-6">
                  {['expense', 'transfer', 'income'].map(m => (
                     <button key={m} onClick={() => { setMode(m); setIsExternal(false); }} className={`flex-1 py-2 text-sm font-bold capitalize rounded-lg transition-all ${mode === m ? 'bg-white shadow-sm text-zinc-900' : 'text-zinc-400'}`}>
                        {m}
                     </button>
                  ))}
               </div>

               <form onSubmit={handleSubmit} className="space-y-4">
                  {/* Amount */}
                  <div className="relative">
                     <span className="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-bold text-zinc-300">$</span>
                     <input type="number" inputMode="decimal" step="0.01" autoFocus placeholder="0.00"
                        value={amount} onChange={e => setAmount(e.target.value)}
                        className="w-full pl-10 pr-4 py-4 text-4xl font-black bg-zinc-50 border-none rounded-2xl focus:ring-2 focus:ring-zinc-900 placeholder-zinc-200 outline-none" 
                     />
                  </div>

                  {/* Quick Dates */}
                  <div className="flex gap-2 mb-2">
                     <button type="button" onClick={() => setDate(new Date().toISOString().split('T')[0])} className={`px-3 py-1 rounded-full text-xs font-bold ${date === new Date().toISOString().split('T')[0] ? 'bg-zinc-900 text-white' : 'bg-zinc-100'}`}>Today</button>
                     <button type="button" onClick={() => { const d = new Date(); d.setDate(d.getDate()-1); setDate(d.toISOString().split('T')[0]); }} className="px-3 py-1 rounded-full text-xs font-bold bg-zinc-100 text-zinc-600">Yesterday</button>
                     <input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-transparent text-xs font-bold text-zinc-400" />
                  </div>

                  {mode === 'transfer' ? (
                     <div className="space-y-4">
                        <div className="flex gap-2 items-center">
                           <div className="flex-1">
                              <label className="text-[10px] font-bold text-zinc-400 uppercase">From</label>
                              <select value={isExternal ? 'ext' : accId} onChange={e => {
                                 if(e.target.value === 'ext') { setIsExternal(true); setAccId(''); }
                                 else { setIsExternal(false); setAccId(e.target.value); }
                              }} className="w-full p-3 bg-zinc-50 rounded-xl font-bold text-sm">
                                 <option value="">Select...</option>
                                 <option value="ext">External / Income</option>
                                 {data.accounts.filter(a => a.type === 'asset').map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                              </select>
                           </div>
                           <Icon name="arrowRight" className="text-zinc-300 mt-4"/>
                           <div className="flex-1">
                              <label className="text-[10px] font-bold text-zinc-400 uppercase">To (Credit Card)</label>
                              <select value={toAccId} onChange={e => setToAccId(e.target.value)} className="w-full p-3 bg-zinc-50 rounded-xl font-bold text-sm">
                                 <option value="">Select...</option>
                                 {data.accounts.filter(a => a.type === 'liability').map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                              </select>
                           </div>
                        </div>
                     </div>
                  ) : (
                     <>
                        <input placeholder="Description (e.g. Wawa)" value={desc} onChange={e => setDesc(e.target.value)} className="w-full p-4 bg-zinc-50 rounded-xl font-medium" />
                        {/* Suggestions */}
                        {suggestions.length > 0 && (
                           <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                              {suggestions.map(s => <button type="button" key={s} onClick={() => setCat(s)} className={`px-3 py-1 text-xs font-bold rounded-full border ${cat === s ? 'bg-zinc-900 text-white' : 'bg-white border-zinc-200'}`}>{s}</button>)}
                           </div>
                        )}
                        <div className="flex gap-2">
                           <select value={accId} onChange={e => setAccId(e.target.value)} className="flex-1 p-3 bg-zinc-50 rounded-xl text-sm font-bold" required>
                              <option value="">Account...</option>
                              {data.accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                           </select>
                           <select value={cat} onChange={e => setCat(e.target.value)} className="flex-1 p-3 bg-zinc-50 rounded-xl text-sm font-bold" required>
                              <option value="">Category...</option>
                              {['Food','Housing','Transport','Vehicle','Personal','Medical','Services'].map(c => <option key={c} value={c}>{c}</option>)}
                           </select>
                        </div>
                        {(cat === 'Vehicle' || cat === 'Transport') && (
                           <div className="bg-zinc-50 p-3 rounded-xl space-y-3">
                              <select value={vehId} onChange={e => setVehId(e.target.value)} className="w-full p-3 bg-white rounded-lg text-sm font-bold">
                                 <option value="">Which Vehicle?</option>
                                 {data.vehicles.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                              </select>
                              <input type="number" placeholder="Current Odometer" value={odo} onChange={e => setOdo(e.target.value)} className="w-full p-3 bg-white rounded-lg text-sm" />
                           </div>
                        )}
                     </>
                  )}

                  <button className="w-full bg-zinc-900 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">Save</button>
               </form>
            </div>
         </div>
       );
    };

    // --- VIEWS ---
    
    // Grouped List Component (Day Headers)
    const GroupedList = ({ txs, accounts, onDelete }) => {
       // Group by Date
       const groups = {};
       txs.forEach(t => {
          if(!groups[t.date]) groups[t.date] = [];
          groups[t.date].push(t);
       });
       
       const sortedDates = Object.keys(groups).sort((a,b) => new Date(b) - new Date(a));
       const [confirmDel, setConfirmDel] = useState(null); // ID for 2-tap delete

       return (
          <div className="space-y-4">
             {sortedDates.map(date => (
                <div key={date}>
                   <div className="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-2 sticky top-14 bg-zinc-50/90 backdrop-blur py-1 z-10">
                      {date === new Date().toISOString().split('T')[0] ? 'Today' : Format.date(date)}
                   </div>
                   <div className="bg-white rounded-2xl shadow-sm border border-zinc-100 overflow-hidden">
                      {groups[date].map(t => (
                         <div key={t.id} className="flex justify-between items-center p-4 border-b border-zinc-50 last:border-0 active:bg-zinc-50">
                            <div className="flex items-center gap-3 overflow-hidden">
                               <div className={`shrink-0 p-2 rounded-full ${t.category.includes('Transfer') ? 'bg-zinc-100 text-zinc-400' : (t.amount > 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600')}`}>
                                  <Icon name={t.category.includes('Transfer') ? 'arrowRight' : (t.amount > 0 ? 'trendingUp' : 'trendingDown')} size={16} />
                               </div>
                               <div className="min-w-0">
                                  <div className="font-bold text-sm text-zinc-800 truncate">{t.description}</div>
                                  <div className="text-[10px] text-zinc-400 font-bold uppercase truncate">
                                     {t.category} • {accounts.find(a=>a.id===t.accountId)?.name}
                                     {t.odometer ? ` • ${t.odometer} mi` : ''}
                                  </div>
                               </div>
                            </div>
                            <div className="flex items-center gap-3 shrink-0">
                               <div className={`font-bold text-sm ${t.category.includes('Transfer') ? 'text-zinc-400' : (t.amount>0?'text-emerald-600':'text-zinc-900')}`}>
                                  {Format.money(t.amount)}
                               </div>
                               {/* 2-Tap Delete */}
                               <button 
                                 onClick={() => {
                                    if(confirmDel === t.id) { onDelete(t.id); setConfirmDel(null); }
                                    else { setConfirmDel(t.id); setTimeout(() => setConfirmDel(null), 3000); }
                                 }}
                                 className={`p-2 rounded-lg transition-colors ${confirmDel === t.id ? 'bg-rose-100 text-rose-600' : 'text-zinc-300'}`}
                               >
                                  <Icon name="trash" size={16} />
                               </button>
                            </div>
                         </div>
                      ))}
                   </div>
                </div>
             ))}
          </div>
       );
    };

    const CFOView = ({ data, actions }) => {
      const assetAccts = data.accounts.filter(a => a.type === 'asset');
      const liabilityAccts = data.accounts.filter(a => a.type === 'liability');
      
      const getBal = (accId) => data.transactions.filter(t => t.accountId === accId).reduce((s,t) => s + t.amount, 0);
      const totalCash = assetAccts.reduce((s, a) => s + getBal(a.id), 0);
      const totalDebt = liabilityAccts.reduce((s, a) => s + getBal(a.id), 0);
      const netLiquid = totalCash + totalDebt; 

      return (
        <div className="p-4 space-y-6 pb-24 animate-fade-in">
          {/* Net Liquid HUD */}
          <div className="bg-zinc-900 text-white p-6 rounded-3xl shadow-2xl relative overflow-hidden">
            <div className="relative z-10">
               <div className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1">Net Liquid</div>
               <div className="text-4xl font-black tracking-tighter">{Format.money(netLiquid)}</div>
               <div className="flex gap-6 mt-6 pt-4 border-t border-zinc-800">
                  <div>
                     <div className="text-[10px] text-zinc-500 font-bold uppercase">Cash</div>
                     <div className="text-lg font-bold text-emerald-500">{Format.money(totalCash)}</div>
                  </div>
                  <div>
                     <div className="text-[10px] text-zinc-500 font-bold uppercase">Debt</div>
                     <div className="text-lg font-bold text-rose-500">{Format.money(totalDebt)}</div>
                  </div>
               </div>
            </div>
          </div>

          <GroupedList txs={data.transactions.slice(0, 10)} accounts={data.accounts} onDelete={actions.deleteTransaction} />
        </div>
      );
    };

    const AccountsView = ({ data, actions }) => {
       const [isAdding, setIsAdding] = useState(false);
       
       return (
          <div className="p-4 space-y-4 pb-24 animate-fade-in">
             <div className="flex justify-between items-center"><h2 className="text-2xl font-black">Accounts</h2><button onClick={() => setIsAdding(!isAdding)} className="bg-zinc-900 text-white px-4 py-2 rounded-lg font-bold text-sm">Add</button></div>
             
             {isAdding && (
               <form onSubmit={(e) => { e.preventDefault(); actions.saveAccount({ name: e.target.name.value, type: e.target.type.value, limit: e.target.limit.value }); setIsAdding(false); }} className="bg-white p-4 rounded-xl shadow space-y-3">
                 <select name="type" className="w-full p-3 bg-zinc-50 rounded-lg"><option value="liability">Credit Card</option><option value="asset">Checking</option></select>
                 <input name="name" placeholder="Name" className="w-full p-3 bg-zinc-50 rounded-lg" required />
                 <input name="limit" type="number" placeholder="Limit (Optional)" className="w-full p-3 bg-zinc-50 rounded-lg" />
                 <button className="w-full bg-black text-white py-3 rounded-lg font-bold">Save</button>
               </form>
             )}

             <div className="space-y-3">
                {data.accounts.map(a => {
                   const bal = data.transactions.filter(t => t.accountId === a.id).reduce((s,t) => s + t.amount, 0);
                   const limit = parseFloat(a.limit || 0);
                   const util = limit > 0 ? Math.abs(bal) / limit : 0;
                   const isAlert = a.type === 'liability' && util > 0.9;

                   return (
                      <div key={a.id} className={`p-4 bg-white border ${isAlert ? 'border-rose-300 ring-2 ring-rose-100' : 'border-zinc-100'} rounded-xl shadow-sm`}>
                         <div className="flex justify-between items-center mb-2">
                            <div>
                               <div className="font-bold text-zinc-900 flex items-center gap-2">
                                  {a.name}
                                  {isAlert && <Icon name="alert" size={14} className="text-rose-500"/>}
                               </div>
                               <div className="text-xs text-zinc-400 capitalize">{a.type}</div>
                            </div>
                            <div className="text-right">
                               <div className={`font-black ${bal >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                  {/* Absolute Value Visual for Liabilities logic */}
                                  {a.type === 'liability' ? Format.money(Math.abs(bal)) : Format.money(bal)}
                               </div>
                               {/* Pay Button for Liabilities */}
                               {a.type === 'liability' && (
                                  <button onClick={() => actions.openModal('add', { mode: 'transfer', amount: bal, toAccountId: a.id })} className="mt-1 text-xs bg-zinc-900 text-white px-3 py-1 rounded-full font-bold">Pay Card</button>
                               )}
                            </div>
                         </div>
                         {/* Progress Bar */}
                         {limit > 0 && (
                            <div className="h-2 bg-zinc-100 rounded-full overflow-hidden mt-2">
                               <div className={`h-full ${isAlert ? 'bg-rose-500' : 'bg-zinc-500'}`} style={{width: `${Math.min(util*100, 100)}%`}}></div>
                            </div>
                         )}
                      </div>
                   )
                })}
             </div>
          </div>
       );
    };

    const GarageView = ({ data, actions }) => {
       const [isAdding, setIsAdding] = useState(false);
       return (
          <div className="p-4 space-y-4 pb-24 animate-fade-in">
             <div className="flex justify-between items-center"><h2 className="text-2xl font-black">Garage</h2><button onClick={() => setIsAdding(!isAdding)} className="p-2 bg-zinc-100 rounded-lg"><Icon name="plus" size={20}/></button></div>
             {isAdding && <form onSubmit={(e) => { e.preventDefault(); actions.saveVehicle({ name: e.target.name.value, startOdo: e.target.odo.value, status: 'active' }); setIsAdding(false); }} className="bg-white p-4 rounded-xl shadow space-y-3"><input name="name" placeholder="Name" className="w-full p-3 bg-zinc-50 rounded-lg" required /><input name="odo" type="number" placeholder="Start Odo" className="w-full p-3 bg-zinc-50 rounded-lg" required /><button className="w-full bg-zinc-900 text-white font-bold py-3 rounded-lg">Add</button></form>}
             
             {data.vehicles.filter(v => v.status !== 'archived').map(v => {
                const txs = data.transactions.filter(t => t.vehicleId === v.id);
                const totalCost = txs.reduce((s,t) => s + Math.abs(t.amount), 0);
                let currentOdo = v.startOdo || 0;
                txs.forEach(t => { if(t.odometer > currentOdo) currentOdo = t.odometer; });
                const dist = Math.max(1, currentOdo - (v.startOdo || 0));
                
                return (
                   <div key={v.id} className="bg-white p-5 rounded-2xl border border-zinc-100 shadow-sm">
                      <div className="flex justify-between items-center mb-4">
                         <div className="flex items-center gap-3">
                            <div className="p-3 bg-zinc-100 text-zinc-600 rounded-xl"><Icon name="car" size={24}/></div>
                            <div>
                               <div className="font-bold text-lg text-zinc-900">{v.name}</div>
                               <div className="text-[10px] text-zinc-400 font-bold uppercase">{currentOdo.toLocaleString()} Miles</div>
                            </div>
                         </div>
                         <div className="text-right">
                             <div className="text-[10px] text-zinc-400 uppercase font-bold">Cost / Mile</div>
                             <div className="text-xl font-black text-rose-500">${(totalCost / dist).toFixed(2)}</div>
                         </div>
                      </div>
                      <div className="flex gap-2">
                         <button onClick={() => actions.saveVehicle({...v, status: 'archived'})} className="flex-1 py-2 bg-zinc-50 text-xs font-bold text-zinc-400 rounded-lg">Archive</button>
                      </div>
                   </div>
                );
             })}
          </div>
       );
    };

    const ToolsView = ({ data, actions }) => {
       return (
          <div className="p-4 space-y-6 pb-24 animate-fade-in">
             <h2 className="text-2xl font-black">Tools</h2>
             <div className="bg-white p-6 rounded-2xl border border-zinc-100 shadow-sm">
                <h3 className="font-bold mb-4">Learned Rules</h3>
                <div className="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                   {data.rules.map(r => (
                      <div key={r.id} className="flex justify-between items-center text-sm p-2 bg-zinc-50 rounded-lg">
                         <span>{r.merchant} <span className="text-zinc-400">→</span> {r.category}</span>
                         <button onClick={() => actions.deleteRule(r.id)} className="text-rose-400"><Icon name="trash" size={14}/></button>
                      </div>
                   ))}
                   {data.rules.length === 0 && <div className="text-zinc-400 text-xs">No rules yet.</div>}
                </div>
             </div>
             <button onClick={actions.exportData} className="w-full bg-white border border-zinc-200 p-4 rounded-xl font-bold flex justify-center gap-2"><Icon name="download" size={20}/> Export CSV</button>
             <button onClick={actions.logout} className="w-full bg-rose-50 text-rose-600 p-4 rounded-xl font-bold flex justify-center gap-2"><Icon name="logOut" size={20}/> Sign Out</button>
          </div>
       );
    };

    // --- MAIN APP SHELL ---
    const App = () => {
      const { user, loading, actions, data, modal } = useContext(AppContext);
      const [tab, setTab] = useState('cfo');

      if (loading) return <div className="h-screen flex items-center justify-center font-bold text-zinc-400">Loading Relly v10...</div>;
      if (!user) return (
        <div className="h-screen flex flex-col items-center justify-center p-6 bg-zinc-50">
          <div className="w-24 h-24 bg-zinc-900 rounded-3xl flex items-center justify-center shadow-xl mb-8"><Icon name="pieChart" size={48} className="text-white"/></div>
          <h1 className="text-4xl font-black text-zinc-900 mb-2">Relly v10</h1>
          <button onClick={actions.login} className="bg-zinc-900 text-white px-10 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform">Sign in with Google</button>
        </div>
      );

      return (
        <div className="min-h-screen bg-zinc-50 pb-safe pt-safe">
           <div className="glass sticky top-0 z-30 px-6 py-4 flex justify-between items-center">
              <h1 className="text-xl font-black text-zinc-900 tracking-tight">Relly<span className="text-emerald-500">.</span></h1>
              <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
           </div>

           <div className="max-w-lg mx-auto">
              {tab === 'cfo' && <CFOView data={data} actions={actions} />}
              {tab === 'garage' && <GarageView data={data} actions={actions} />}
              {tab === 'accounts' && <AccountsView data={data} actions={actions} />}
              {tab === 'tools' && <ToolsView data={data} actions={actions} />}
           </div>

           <button onClick={() => actions.openModal('add')} className="fixed bottom-24 right-6 w-16 h-16 bg-zinc-900 text-white rounded-full shadow-2xl flex items-center justify-center btn-press z-40"><Icon name="plus" size={32} /></button>

           <div className="fixed bottom-0 left-0 right-0 glass border-t border-zinc-200 px-6 py-3 pb-8 flex justify-between items-center z-50 max-w-lg mx-auto">
              {['cfo', 'garage', 'accounts', 'tools'].map(t => (
                 <button key={t} onClick={() => setTab(t)} className={`flex flex-col items-center gap-1 transition-colors ${tab===t ? 'text-zinc-900' : 'text-zinc-400'}`}>
                    <Icon name={t === 'cfo' ? 'home' : (t === 'garage' ? 'car' : (t === 'accounts' ? 'creditCard' : 'settings'))} size={24} />
                    <span className="text-[10px] font-bold uppercase tracking-wider">{t}</span>
                 </button>
              ))}
           </div>
           
           <AddModal />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ToastProvider>
        <AppProvider>
          <App />
        </AppProvider>
      </ToastProvider>
    );
  </script>
</body>
</html>
